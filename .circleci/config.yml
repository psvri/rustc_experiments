version: 2.1

jobs:
  build:
    machine:
      image: ubuntu-2204:2022.10.2
      resource_class: large
    steps:
      - checkout
      - run:
          name: "Setup rust code"
          command: |
            sudo apt-get update -y
            sudo apt-get install -y ninja-build zstd
            git clone https://github.com/rust-lang/rust.git
            cd rust
            cp ../patches/v2/config.toml .
            cp ../patches/v2/x86_64_unknown_linux_gnu.rs compiler\rustc_target\src\spec\x86_64_unknown_linux_gnu.rs
      - run:
          name: "Build rustc-x86-v2"
          command: |
            cd rust
            ./x.py build compiler/rustc
      - run:
          name: "print rustc-x86-64-v2 flags"
          command: |
            ./rust/build/x86_64-unknown-linux-gnu/stage2/bin/rustc --print=cfg
          when: always
      - run:
          name: "tar rustc-x86-64-v2"
          command: |
            tar --zstd -cf rustc-x86-64-v2.tar.zst .rust/build/x86_64-unknown-linux-gnu/stage2
          when: always
      - store_artifacts:
          path: rustc-x86-64-v2.tar.zst
          when: always

# Invoke jobs via workflows
# See: https://circleci.com/docs/2.0/configuration-reference/#workflows
workflows:
  build-x86-64-v2:
    jobs:
      - build
